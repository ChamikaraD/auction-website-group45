@model PaginatedList<Project_1.Models.Bid>
@using System.Security.Claims // Needed for currentUserId

@{
    ViewData["Title"] = "My Bids";
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier); // Get current user's ID
}

<div class="container mt-5">
    <h2 class="text-center mb-4" style="font-family: 'Playfair Display', serif; color: #D4AF37; text-transform: uppercase;">My Bids</h2>

    @if (!Model.Any())
    {
        <div class="no-auctions-message text-center">
            <p>You have not placed any bids yet.</p>
        </div>
    }
    else
    {
        <div class="auction-grid">
            @foreach (var bid in Model)
            {
                // Get the associated listing for easier checks
                var listing = bid.Listing;

                // Calculate the highest bid specifically for this listing
                var highestBidForThisListing = listing?.Bids?.OrderByDescending(b => b.Price).FirstOrDefault();

                <div class="auction-card">
                    <div class="card-image">
                        <img src="~/Images/@listing?.ImagePath" alt="@listing?.Title" />
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">
                            <a asp-action="Details" asp-route-id="@listing?.Id" style="color: #f0f0f0; text-decoration: none;">
                                @listing?.Title
                            </a>
                        </h3>
                        <p class="card-bid-label">Your Bid</p>
                        <p class="card-bid-price">Rs @bid.Price.ToString("N2")</p>
                        <p class="card-timer" style="font-size: 0.9rem; color: #ccc;">
                            Listed by: @listing?.User?.Email
                        </p>

                        @if (listing != null && listing.IsSold && highestBidForThisListing != null && highestBidForThisListing.Id == bid.Id /* && !listing.IsPaid (Optional check) */ )
                        {
                            <form asp-controller="Payment" asp-action="CreateCheckoutSession" method="post" style="margin-top: 15px;">
                                <input type="hidden" name="listingId" value="@listing.Id" />
                                <button type="submit" class="btn btn-primary-gold" style="width: 100%;">Pay Now (Rs @bid.Price.ToString("N2"))</button>
                                @Html.AntiForgeryToken()
                            </form>
                        }
                        else // Otherwise, show the View Listing button
                        {
                            <a asp-action="Details" asp-route-id="@listing?.Id" class="btn btn-secondary-gold" style="margin-top: 15px;">View Listing</a>
                        }
                    </div>
                </div>
            }
        </div>
    }

    <div class="pagination-container mt-4">
        @{
            var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
            var nextDisabled = !Model.HasNextPage ? "disabled" : "";
        }
        <a asp-action="MyBids" asp-route-pageNumber="@(Model.PageIndex - 1)" class="btn btn-secondary-dark @prevDisabled">Previous</a>
        <span class="pagination-page-info">Page @Model.PageIndex of @Model.TotalPages</span>
        <a asp-action="MyBids" asp-route-pageNumber="@(Model.PageIndex + 1)" class="btn btn-secondary-dark @nextDisabled">Next</a>
    </div>
</div>